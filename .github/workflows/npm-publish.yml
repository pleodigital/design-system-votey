name: ğŸ“¦ NPM Publish on Merge

on:
  push:
    # Wyzwalaj TYLKO po zmergowaniu do gaÅ‚Ä™zi main
    branches:
      - main

jobs:
  publish:
    # Uruchom tylko wtedy, gdy w commitach, ktÃ³re zÅ‚oÅ¼yÅ‚y siÄ™ na merge,
    # pojawiÅ‚a siÄ™ fraza 'chore(tokens):' (zwykle uÅ¼ywana w auto-PR) lub 'publish'
    if: contains(github.event.head_commit.message, 'chore(tokens):') || contains(github.event.head_commit.message, 'publish')

    runs-on: ubuntu-latest

    # Uprawnienia dla bota GitHub, wymagane do interakcji z paczkami
    permissions:
      contents: write # Do robienia commita z nowÄ… wersjÄ… (jeÅ›li bÄ™dziesz wersjonowaÄ‡)
      packages: write # Wymagane, jeÅ›li uÅ¼ywasz GitHub Packages
      id-token: write # Wymagane dla OIDC/NPM Login (nowoczesna metoda)

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org/'

      - name: ğŸ”§ Install dependencies
        run: npm install

      # 1. Buduj tokeny (upewnij siÄ™, Å¼e folder dist/ jest Å›wieÅ¼y)
      # Ten krok jest opcjonalny, jeÅ›li ufasz, Å¼e folder dist/ jest zawsze zmergowany
      # ale jest dobrym zabezpieczeniem.
      - name: ğŸ¨ Build Design Tokens
        run: npm run build

      # 2. ZwiÄ™kszenie wersji paczki (Automatyczne wersjonowanie)
      # UÅ¼ywamy npm version patch, co zmieni 1.0.0 na 1.0.1
      - name: ğŸ“ˆ Increment Package Version
        run: npm version patch --no-git-tag-version

      # 3. Konfiguracja Git dla commita (wymagane dla 'npm version')
      - name: âš™ï¸ Configure Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 4. Commit nowej wersji (np. 1.0.1) i wypchniÄ™cie do 'main'
      - name: ğŸ’¾ Commit new version
        run: |
          git add package.json
          git commit -m "chore(release): new version $(node -p "require('./package.json').version")"
          git push

      # 5. Publikacja paczki
      - name: ğŸš€ Publish to NPM
        run: npm publish --access public # ZmieÅ„ na --access restricted dla paczek prywatnych
        env:
          # Token dostÄ™pu do NPM (ustawiony w GitHub Secrets)
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
